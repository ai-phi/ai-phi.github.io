---
import { SITE } from "@config";
import Breadcrumbs from "@components/Breadcrumbs.astro";
import Footer from "@components/Footer.astro";
import Header from "@components/Header.astro";
import Layout from "../../layouts/Layout.astro";
import PDFViewer from "../../components/PDFViewer.astro";
import Pagination from "../../components/Pagination.astro";
import { getCollection } from "astro:content";

const pageTitle = "Resources";
const pageDescription =
  "These serve as a record of our sessions and a way to share outputs.";

// Pagination parameters
const POSTS_PER_PAGE = 3;
const currentPage = 1;

// Get all content entries that might have slides
const [posts, sessions] = await Promise.all([
  getCollection("posts"),
  getCollection("sessions"),
]);
const allPosts = [...posts, ...sessions];

// Filter posts that contain PDF comments
const postsWithPDFs = allPosts.filter(post => {
  return post.body.includes("<!-- PDF:") && post.body.includes(".pdf");
});

// Extract presentation data from posts
const presentations = postsWithPDFs
  .flatMap(post => {
    const pdfRegex =
      /<!--\s*PDF:\s*([^|]+?)(?:\s*\|\s*title:\s*([^|]+?))?(?:\s*\|\s*type:\s*([^|]+?))?\s*-->/g;
    const pdfMatches = [...post.body.matchAll(pdfRegex)];

    if (pdfMatches.length === 0) return [];

    return pdfMatches.map((pdfMatch, index) => {
      const filename = pdfMatch[1].trim();
      const title = pdfMatch[2] ? pdfMatch[2].trim() : null;
      const type = pdfMatch[3] ? pdfMatch[3].trim() : "seminar";
      const pdfPath = `/pdfs/${filename}`;
      const pdfTitle = title || post.data.title;

      return {
        title: pdfTitle,
        pdfPath: pdfPath,
        postTitle: post.data.title,
        postSlug: post.slug,
        pubDatetime: post.data.pubDatetime,
        description: post.data.description,
        type: type,
      };
    });
  })
  .filter(presentation => presentation.pdfPath);

// Sort presentations by date (newest first)
presentations.sort(
  (a, b) =>
    new Date(b.pubDatetime).getTime() - new Date(a.pubDatetime).getTime()
);

// Calculate pagination for all presentations (client-side filtering will handle the rest)
const totalPresentations = presentations.length;
const totalPages = Math.ceil(totalPresentations / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const paginatedPresentations = presentations.slice(startIndex, endIndex);

// Make all presentations available for client-side filtering
const allPresentations = presentations;
---

<Layout title={`${pageTitle} | ${SITE.title}`} description={pageDescription}>
  <Header activeNav="resources" />
  <Breadcrumbs />
  <main id="main-content" class="@container">
    <h1>{pageTitle}</h1>
    <p>{pageDescription}</p>

    <div class="resources-content">
      <section class="mb-12">
        <h2 class="section-title">Slides</h2>
        <p class="section-description">
          Slides from our sessions. Various sessions were preceeded by a
          'preamble' which typically included news and updates.
        </p>

        <!-- Filter buttons -->
        <div class="filter-container">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="presentation"
            >Presentations</button
          >
          <button class="filter-btn" data-filter="preamble"
            >Preambles & News</button
          >
        </div>

        {
          allPresentations.length > 0 ? (
            <div class="presentations-list">
              {allPresentations.map((presentation, index) => (
                <div
                  class="presentation-card"
                  data-type={presentation.type}
                  data-index={index}
                  style={index >= POSTS_PER_PAGE ? "display: none;" : ""}
                >
                  <div class="presentation-title">
                    <h3>{presentation.title}</h3>
                  </div>
                  <PDFViewer src={presentation.pdfPath} height="380px" />
                  <div class="presentation-footer">
                    <div class="presentation-info">
                      <div class="presentation-date">
                        {presentation.pubDatetime.toLocaleDateString("en-US", {
                          year: "numeric",
                          month: "long",
                          day: "numeric",
                        })}
                      </div>
                      <div class="presentation-source">
                        <a
                          href={`/posts/${presentation.postSlug}`}
                          class="text-skin-accent hover:underline"
                        >
                          From: {presentation.postTitle}
                        </a>
                      </div>
                    </div>
                    <div class="presentation-download">
                      <a
                        href={presentation.pdfPath}
                        download
                        class="download-btn"
                      >
                        ðŸ“„ Download PDF
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="pdf-placeholder">
              <p class="text-skin-base opacity-70">
                ðŸ“„ No presentations found. Presentations will appear here when
                PDFs are attached to blog posts.
              </p>
            </div>
          )
        }

        <!-- Dynamic pagination (controlled by JavaScript) -->
        <div
          class="pagination-wrapper"
          id="pagination-container"
          style="display: none;"
        >
          <nav class="pagination-nav" aria-label="Pagination">
            <!-- Previous/First buttons -->
            <button
              id="first-btn"
              class="pagination-btn"
              style="display: none;"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="pagination-svg"
                viewBox="0 0 24 24"
              >
                <path
                  d="M18.41 16.59L13.82 12l4.59-4.59L17 6l-6 6 6 6 1.41-1.41z"
                ></path>
                <path d="M11 16.59L6.41 12 11 7.41 9.59 6l-6 6 6 6L11 16.59z"
                ></path>
              </svg>
              <span class="ml-1 pagination-text">First</span>
            </button>

            <button id="prev-btn" class="pagination-btn" style="display: none;">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="pagination-svg"
                viewBox="0 0 24 24"
              >
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
              </svg>
              <span class="ml-1 pagination-text">Prev</span>
            </button>

            <!-- Page numbers -->
            <div class="pagination-numbers mx-4" id="page-numbers">1 / 1</div>

            <!-- Next/Last buttons -->
            <button id="next-btn" class="pagination-btn" style="display: none;">
              <span class="mr-1 pagination-text">Next</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="pagination-svg"
                viewBox="0 0 24 24"
              >
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"></path>
              </svg>
            </button>

            <button id="last-btn" class="pagination-btn" style="display: none;">
              <span class="mr-1 pagination-text">Last</span>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="pagination-svg"
                viewBox="0 0 24 24"
              >
                <path d="M5.59 7.41L10.17 12l-4.58 4.59L7 18l6-6-6-6-1.41 1.41z"
                ></path>
                <path
                  d="M12.59 7.41L17.17 12l-4.58 4.59L14 18l6-6-6-6-1.41 1.41z"
                ></path>
              </svg>
            </button>
          </nav>
        </div>
      </section>
    </div>
  </main>
  <Footer />
</Layout>

<style>
  #main-content {
    @apply mx-auto w-full max-w-3xl px-4 pb-4;
  }

  #main-content h1 {
    @apply text-2xl font-semibold sm:text-3xl;
  }

  #main-content p {
    @apply mb-6 mt-2 italic;
  }

  .resources-content {
    @apply space-y-8;
    padding-right: 20px;
    padding-left: 20px;
  }

  .section-title {
    @apply mb-3 text-2xl font-semibold text-skin-accent;
    border-bottom: 2px solid #000000;
    padding-bottom: 0.1rem;
  }

  html[data-theme="dark"] .section-title {
    border-bottom: 2px solid #ffffff;
  }

  .section-description {
    @apply mb-6 text-skin-base opacity-70;
  }

  .pdf-placeholder {
    @apply rounded-lg border-2 border-dashed border-skin-line p-8 text-center;
  }

  .presentations-list {
    @apply space-y-0;
  }

  .presentation-card {
    @apply bg-skin-card;
    border-radius: 0.9rem;
    border: 2px solid rgb(0 0 0 / 10%);
    margin-top: 0rem;
    margin-bottom: 1rem !important;
  }

  html[data-theme="dark"] .presentation-card {
    border: 2px solid rgb(255 255 255 / 20%);
  }

  .presentation-title {
    padding-left: 1rem;
    padding-right: 1rem;
    padding-top: 0.4rem;
  }

  .presentation-title h3 {
    @apply mb-0 text-skin-base;
    font-style: italic;
    font-weight: 200;
    font-size: 16px;
  }

  .presentation-card:last-child {
    margin-bottom: 0rem !important;
  }

  .presentation-footer {
    @apply flex items-center justify-between p-4 text-sm text-skin-base opacity-70;
  }

  .presentation-info {
    @apply flex flex-col;
  }

  .presentation-date {
    @apply mb-1 font-medium;
  }

  .presentation-source {
    @apply text-xs;
  }

  .presentation-download {
    @apply flex-shrink-0;
  }

  .download-btn {
    @apply inline-flex items-center rounded-md bg-transparent px-3 py-1 text-sm text-skin-accent no-underline transition-colors;
  }

  .download-btn:hover {
    background-color: rgb(var(--color-accent)) !important;
    color: white !important;
    opacity: 1 !important;
  }

  /* Override prose hover styles for download button */
  .prose .download-btn:hover {
    background-color: rgb(var(--color-accent)) !important;
    color: white !important;
    opacity: 1 !important;
    text-decoration: none !important;
  }

  .pagination-wrapper {
    @apply mt-8 flex justify-center;

    /* Reduce margin on mobile */
    @media (max-width: 640px) {
      @apply mt-4;
    }
  }

  .pagination-nav {
    @apply mb-8 mt-auto flex items-center justify-center gap-2;

    /* Smaller gap on mobile */
    @media (max-width: 640px) {
      gap: 0rem;
      margin-right: 0rem;
    }

    /* Even smaller gap on very small screens */
    @media (max-width: 480px) {
      gap: 0.125rem;
    }
  }

  /* Filter buttons */
  .filter-container {
    @apply mb-6 flex flex-wrap justify-center gap-2;
  }

  .filter-btn {
    @apply rounded-md border border-skin-line bg-skin-fill px-4 py-1 text-skin-base no-underline transition-all duration-200;
    outline: none;
    border-width: 3px;
    padding-top: 0.1rem;
    padding-bottom: 0.1rem;
    display: inline-block;
  }

  .filter-btn:focus {
    outline: none;
  }

  .filter-btn:hover {
    @apply bg-skin-card;
  }

  .filter-btn.active {
    @apply border-skin-accent bg-skin-accent text-white;
  }

  /* Pagination buttons */
  .pagination-btn {
    @apply inline-flex cursor-pointer items-center border-none bg-transparent px-3 py-2 text-skin-base transition-colors hover:text-skin-accent;
    outline: none;
    min-width: fit-content;

    /* Responsive sizing */
    @media (max-width: 640px) {
      @apply px-2 py-1;
    }
  }

  .pagination-btn:disabled {
    @apply cursor-not-allowed opacity-50;
  }

  .pagination-svg {
    @apply flex-shrink-0 fill-current;
  }

  .pagination-numbers {
    font-size: 1.5rem;
    line-height: 1.75rem;
    font-weight: 600;

    /* Smaller text on mobile */
    @media (max-width: 640px) {
      font-size: 1.25rem;
    }
  }

  .pagination-text {
    font-size: 1.3rem;
    line-height: 1.75rem;
    font-weight: 300;

    /* Smaller text on mobile */
    @media (max-width: 640px) {
      font-size: 1rem;
    }

    /* Hide text labels on very small screens */
    @media (max-width: 480px) {
      display: none;
    }
  }

  /* Match posts pagination nav styling */
  nav {
    @apply text-lg;
  }

  /* Responsive link/button styling to match posts */
  nav a,
  nav span {
    /* Smaller padding on mobile */
    @media (max-width: 640px) {
      @apply px-2 py-1;
    }
  }

  /* PDF viewer styles (for dynamically loaded PDFs) */
  .pdf-viewer-container {
    position: relative;
    padding: 0.625rem;
  }

  .pdf-viewer {
    overflow: hidden;
    border-radius: 0.5rem;
    border: 1px solid rgb(var(--color-border));
    box-shadow:
      0 10px 15px -3px rgb(0 0 0 / 0.1),
      0 4px 6px -4px rgb(0 0 0 / 0.1);
  }

  .pdf-iframe {
    border: none;
  }

  .pdf-fallback {
    @apply bg-skin-fill p-8 text-center;
  }

  .pdf-fallback a {
    @apply text-skin-accent hover:underline;
  }
</style>

<script>
  console.log("Resources script loaded");

  let initAttempts = 0;
  const maxInitAttempts = 20; // Max 2 seconds of retries

  function initializeWhenReady() {
    initAttempts++;
    const filterButtons =
      document.querySelectorAll<HTMLButtonElement>(".filter-btn");
    const presentationCards =
      document.querySelectorAll<HTMLElement>(".presentation-card");
    const pageNumbers = document.getElementById("page-numbers");
    const paginationContainer = document.getElementById("pagination-container");
    const firstBtn = document.getElementById(
      "first-btn"
    ) as HTMLButtonElement | null;
    const prevBtn = document.getElementById(
      "prev-btn"
    ) as HTMLButtonElement | null;
    const nextBtn = document.getElementById(
      "next-btn"
    ) as HTMLButtonElement | null;
    const lastBtn = document.getElementById(
      "last-btn"
    ) as HTMLButtonElement | null;

    // Check if all elements are loaded - we expect at least a few presentation cards
    const expectedMinCards = 3; // Adjust based on your content
    const isNavigatedPage =
      document.readyState === "complete" && initAttempts === 1;

    if (
      (presentationCards.length < expectedMinCards ||
        !pageNumbers ||
        !paginationContainer) &&
      initAttempts < maxInitAttempts
    ) {
      // Use longer delay for navigation scenarios
      const retryDelay = isNavigatedPage ? 200 : 100;
      setTimeout(initializeWhenReady, retryDelay);
      return;
    }

    if (initAttempts >= maxInitAttempts) {
      console.warn(
        "Max initialization attempts reached, proceeding with available elements"
      );
    }

    const POSTS_PER_PAGE = 3;
    let currentFilter = "all";
    let currentPage = 1;
    let filteredCards: HTMLElement[] = [];

    // Initialize the filtering system
    function init() {
      currentFilter = "all";
      currentPage = 1;
      applyFilter(currentFilter);
    }

    // Filter presentations based on type
    function applyFilter(filterType: string) {
      console.log("Applying filter:", filterType);
      currentFilter = filterType;
      currentPage = 1; // Reset to first page when filtering

      // Update active button
      filterButtons.forEach(btn => {
        btn.classList.remove("active");
        if (btn.getAttribute("data-filter") === filterType) {
          btn.classList.add("active");
        }
      });

      // Get filtered cards
      filteredCards = Array.from(presentationCards).filter(card => {
        const cardType = card.getAttribute("data-type");
        if (filterType === "all") {
          return true;
        } else if (filterType === "preamble") {
          return cardType === "preamble" || cardType === "news";
        } else {
          return cardType === filterType;
        }
      });

      console.log("Filtered cards:", filteredCards.length);

      // Update pagination and display
      updatePagination();
      updateDisplay();
    }

    // Update pagination controls
    function updatePagination() {
      console.log("Updating pagination:", filteredCards.length, POSTS_PER_PAGE);
      const totalPages = Math.ceil(filteredCards.length / POSTS_PER_PAGE);

      // Update page numbers
      if (pageNumbers) {
        pageNumbers.textContent = `${currentPage} / ${totalPages}`;
      }
      console.log("Updating pagination:", pageNumbers);

      // Update button states
      if (firstBtn) firstBtn.disabled = currentPage === 1;
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn)
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
      if (lastBtn)
        lastBtn.disabled = currentPage === totalPages || totalPages === 0;

      // Always show pagination container when we have data, hide only if no pages
      if (paginationContainer) {
        if (totalPages === 0 || filteredCards.length === 0) {
          paginationContainer.style.display = "none";
        } else {
          paginationContainer.style.display = "block";
          console.log("Showing pagination container");
        }
      }

      // Update button states
      if (firstBtn) {
        firstBtn.style.display =
          currentPage > 1 && totalPages > 4 ? "flex" : "none";
      }
      if (prevBtn) {
        prevBtn.style.display = currentPage > 1 ? "flex" : "none";
      }
      if (nextBtn) {
        nextBtn.style.display = currentPage < totalPages ? "flex" : "none";
      }
      if (lastBtn) {
        lastBtn.style.display =
          currentPage < totalPages && totalPages > 4 ? "flex" : "none";
      }
    }

    // Update which cards are displayed
    function updateDisplay() {
      // Hide all cards first
      presentationCards.forEach(card => {
        card.style.display = "none";
      });

      // Calculate which cards to show for current page
      const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
      const endIndex = startIndex + POSTS_PER_PAGE;

      // Show the appropriate filtered cards
      for (let i = startIndex; i < endIndex && i < filteredCards.length; i++) {
        const card = filteredCards[i];
        card.style.display = "block";
      }
    }

    // Pagination navigation functions
    function goToPage(page: number) {
      const totalPages = Math.ceil(filteredCards.length / POSTS_PER_PAGE);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updatePagination();
        updateDisplay();

        // Scroll to top of presentations
        const presentationsList = document.querySelector(".presentations-list");
        if (presentationsList) {
          presentationsList.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
        }
      }
    }

    // Event listeners for filter buttons
    filterButtons.forEach(button => {
      button.addEventListener("click", function () {
        const filterType = this.getAttribute("data-filter");
        if (filterType) {
          applyFilter(filterType);
        }
      });
    });

    // Event listeners for pagination buttons
    if (firstBtn) {
      firstBtn.addEventListener("click", () => goToPage(1));
    }
    if (prevBtn) {
      prevBtn.addEventListener("click", () => goToPage(currentPage - 1));
    }
    if (nextBtn) {
      nextBtn.addEventListener("click", () => goToPage(currentPage + 1));
    }
    if (lastBtn) {
      lastBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(filteredCards.length / POSTS_PER_PAGE);
        goToPage(totalPages);
      });
    }

    // Initialize on page load
    init();
  }

  // Start initialization - always use retry logic regardless of ready state
  function startInitialization() {
    console.log("Starting initialization...");
    initAttempts = 0; // Reset attempts counter
    setTimeout(initializeWhenReady, 100); // Longer initial delay for navigation
  }

  // Multiple initialization triggers to handle all navigation scenarios

  // 1. Fresh page load
  document.addEventListener("DOMContentLoaded", startInitialization);

  // 2. Already loaded (first navigation)
  if (document.readyState !== "loading") {
    console.log("DOM already ready, starting initialization");
    setTimeout(startInitialization, 50);
  }

  // 3. Astro page navigation (for cached/repeated visits)
  document.addEventListener("astro:page-load", function () {
    console.log("Astro page load event");
    setTimeout(startInitialization, 100);
  });

  // 4. Fallback for any other navigation patterns
  window.addEventListener("load", function () {
    console.log("Window load event");
    setTimeout(startInitialization, 150);
  });

  // 5. Immediate attempt (covers edge cases)
  setTimeout(startInitialization, 200);
</script>
