---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import Card from "@components/Card";
import Pagination from "@components/Pagination.astro";
import getPostsByTag from "@utils/getPostsByTag";
import getPagination from "@utils/getPagination";
import getUniqueTags from "@utils/getUniqueTags";
import { SITE } from "@config";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const sessions = await getCollection("sessions");

  const tags = getUniqueTags([...posts, ...sessions]);

  return tags.map(({ tag, tagName }) => {
    return {
      params: { tag },
      props: { tag, tagName },
    };
  });
}

const { tag, tagName } = Astro.props;

const posts = await getCollection("posts");
const sessions = await getCollection("sessions");

const postsByTag = getPostsByTag(posts, tag);
const sessionsByTag = getPostsByTag(sessions, tag);

const pagination = getPagination({
  posts: postsByTag,
  page: 1,
  isIndex: true,
});
---

<Layout title={`Tag: ${tagName} | ${SITE.title}`}>
  <Header activeNav="tags" />
  <Main
    pageTitle={[`Tag:`, `${tagName}`]}
    titleTransition={tag}
    pageDesc={`All the articles with the tag "${tagName}".`}
  >
    <h1 slot="title" transition:name={tag}>{`Tag:${tag}`}</h1>
    <ul>
      {
        pagination.paginatedEntries.map(({ data, slug }) => (
          <Card href={`/posts/${slug}`} frontmatter={data} />
        ))
      }
    </ul>
    {
      sessionsByTag.length > 0 && (
        <section class="mt-12">
          <h2 class="text-xl font-semibold">Sessions with this tag</h2>
          <ul>
            {sessionsByTag.map(({ data, slug }) => (
              <Card href={`/posts/${slug}`} frontmatter={data} />
            ))}
          </ul>
        </section>
      )
    }
  </Main>

  <Pagination
    currentPage={pagination.currentPage}
    totalPages={pagination.totalPages}
    prevUrl={`/tags/${tag}${
      pagination.currentPage - 1 !== 1 ? "/" + (pagination.currentPage - 1) : ""
    }`}
    nextUrl={`/tags/${tag}/${pagination.currentPage + 1}`}
    firstUrl={pagination.totalPages > 4 ? `/tags/${tag}` : undefined}
    lastUrl={pagination.totalPages > 4
      ? `/tags/${tag}/${pagination.totalPages}`
      : undefined}
  />

  <Footer noMarginTop={pagination.totalPages > 1} />
</Layout>
